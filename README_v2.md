# 日志清理脚本

## 快速使用

```bash
# 单个目录，磁盘使用率到70%停止清理
./log_cleaner_v2.py /path/to/logs 70

# 多个目录，用冒号分隔
./log_cleaner_v2.py /path1:/path2:/path3 80

# 预览模式（推荐先试用）
./log_cleaner_v2.py /path1:/path2 70 --dry-run

# 自动确认（适合定时任务）
./log_cleaner_v2.py /path1:/path2 70 --auto-confirm
```

## 工作原理

1. **检查磁盘使用率**: 检查所有指定目录的磁盘使用率
2. **判断是否需要清理**: 如果使用率超过阈值才开始清理
3. **安全检查**: 
   - 跳过最近24小时内修改的文件
   - 跳过正在被进程使用的文件（使用lsof/fuser检查）
4. **按时间删除**: 从最旧的文件开始删除
5. **实时监控**: 删除过程中实时检查磁盘使用率
6. **达到阈值停止**: 磁盘使用率降到阈值以下时停止

## 参数说明

- **目录路径**: 单个目录或用冒号分隔的多个目录
- **磁盘使用率阈值**: 1-99之间的整数
  - 70 = 磁盘使用率降到70%时停止清理
  - 80 = 磁盘使用率降到80%时停止清理

## 版本说明

- `log_cleaner.py` - 原版本（按百分比保留文件）
- `log_cleaner_v2.py` - 新版本（按磁盘使用率清理）**推荐**
- `log_cleaner.sh` - Bash版本

## 支持的日志文件

- `*.log` - 通用日志文件
- `log.2025-12-24.0.log` - 按日期命名的日志
- `trace.2025-12-03.0.log` - trace日志
- `1201838490.log` - 数字ID日志
- `2025-12-27/1201838490.log` - 日期目录下的日志

## 定时清理

```bash
# 每天凌晨2点清理，磁盘使用率到70%停止
0 2 * * * /path/to/log_cleaner_v2.py /app/logs:/nginx/logs 70 --auto-confirm
```

## 兼容性

- Python 2.7+ 和 Python 3.x
- 自动处理编码问题
- 跨平台支持

## 安全特性

- **24小时保护**: 自动跳过最近24小时内修改的文件
- **进程检查**: 使用lsof/fuser检查文件是否被进程使用，避免删除正在使用的文件
- **预览模式**: --dry-run避免误删
- **详细报告**: 显示删除和跳过的文件信息
- **实时监控**: 删除过程中实时检查磁盘使用率
